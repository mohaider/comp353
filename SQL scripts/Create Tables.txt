DROP DATABASE IF EXISTS Daycare;
CREATE DATABASE Daycare;

USE Daycare;

CREATE TABLE IF NOT EXISTS Family
(
ID int NOT NULL AUTO_INCREMENT,
EmergencyPhoneNum VARCHAR(12) NOT NULL,
UNIQUE(ID),
PRIMARY KEY(ID)
);

CREATE TABLE IF NOT EXISTS Child
(
MedicareNum VARCHAR(14) NOT NULL,
SEX VARCHAR(12) NOT NULL,
DOB DATE NOT NULL,
Name VARCHAR(100) NOT NULL,
AgeGroup VARCHAR(25) NOT NULL,
UNIQUE(MedicareNum),
PRIMARY KEY(MedicareNum)
);

CREATE TABLE IF NOT EXISTS ChildOf
(
MedicareNum VARCHAR(14) NOT NULL,
FamilyID int NOT NULL,
FOREIGN KEY(MedicareNum)
	REFERENCES Child(MedicareNum)
	ON DELETE CASCADE,
FOREIGN KEY(FamilyID)
	REFERENCES Family(ID),
	ON DELETE CASCADE,
PRIMARY KEY(MedicareNum)
);

CREATE TABLE IF NOT EXISTS AuthorizedContact
(
ContactNumber VARCHAR(12) NOT NULL,
Name VARCHAR(100) NOT NULL,
TypeOfRelationship VARCHAR(50) NOT NULL,
IsEmergencyContact VARCHAR(4) NOT NULL,
CONSTRAINT Chk_Type CHECK (IsEmergencyContact IN ('YES', 'NO')),
UNIQUE (ContactNumber),
PRIMARY KEY(ContactNumber) 
);

CREATE TABLE IF NOT EXISTS IsAuthorized
(
ContactNumber VARCHAR(12) NOT NULL,
FamilyID INT NOT NULL,
FOREIGN KEY (ContactNumber)
	REFERENCES AuthorizedContact(ContactNumber)
	ON DELETE CASCADE,
FOREIGN KEY (FamilyID)
	REFERENCES Family(ID)
	ON DELETE CASCADE,
PRIMARY KEY (ContactNumber)
);


CREATE TABLE IF NOT EXISTS Guardian
(
ID INT NOT NULL AUTO_INCREMENT,
Name VARCHAR(100) NOT NULL,
Address VARCHAR(100) NOT NULL,
PhoneNumber VARCHAR(12) NOT NULL,
GuardianOrParent VHARCHAR(4) NOT NULL,
CONSTRAINT Chk_Parent CHECK (GuardianOrParent IN ('Guardian', 'Parent')),
UNIQUE (ID),
PRIMARY KEY (ID)
);

CREATE TABLE IF NOT EXISTS PrimaryCaretaker
(
FamilyID INT NOT NULL,
GuardianID INT NOT NULL,
FOREIGN KEY (GuardianID)
	REFERENCES Guardian(ID)
	ON DELETE CASCADE,
FOREIGN KEY (FamilyID)
	REFERENCES Family(ID)
	ON DELETE CASCADE,
PRIMARY KEY (FamilyID, GuardianID)
);



DELIMITER $$

CREATE TRIGGER CheckInsertGuardian
BEFORE INSERT
ON PrimaryCaretaker
FOR EACH ROW
BEGIN
  SELECT COUNT(GuardianID) INTO @cnt FROM PrimaryCaretaker GROUP BY FamilyID;
  IF @cnt >= 2 THEN
    CALL sth(); -- raise an error
  END IF;
END
$$

DELIMITER ;